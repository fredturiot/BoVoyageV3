<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8" />
    <title>Edition de Dossier</title>
    <link rel="stylesheet" type="text/css" href="../CSS/style.css" />
    <script src="../JS/script.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous" />
</head>

<body>
    <div class="row">

        <div class="main  col-lg-3 col-md-6 col-sm-6">

            <div class="container-fluid">
                <h3>Editer le Dossier</h3>

                <form novalidate>

                    <div class="form-group">
                        <label for="NumeroCB">Numero de Carte Bancaire</label>
                        <input type="text" placeholder="Numero de Carte Bancaire" class="form-control" id="NumeroCB"
                            required />
                        <div class="invalid-feedback">
                            Champ requis
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="Voyage">Voyage</label>
                        <select class="form-control" id="Voyage" required></select>
                        <div class="invalid-feedback">
                            Champ requis
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="Client">Client</label>
                        <select class="form-control" id="Client" required></select>
                        <div class="invalid-feedback">
                            Champ requis
                        </div>
                    </div>

                </form>

                <div class="actions">
                    <br>
                    <button class="btn btn-primary" onclick="return Enregistrer();">Enregistrer</button>
                    <a href="/Application/HTML/DossierList.html" class="btn btn-light">Annuler</a>
                </div>
            </div>
        </div>

        <div class="main col-lg-3 col-md-6 col-sm-6">
            <div class="container-fluid">
                <h3>Validations</h3>
                <br>
                <button class="btn btn-primary" onclick="return  VerifierSolvabilite();">Verifier Solvabilité</button>
                <br><br>
                <button class="btn btn-success" onclick="return  AccepterDossier();">Accepter la reservation</button>
                <br><br>
                <button class="btn btn-danger" onclick="return  RefuserDossier();">Refuser la reservation</button>

                <br><br>
                <div class="form-group">
                    <label style="display: block;">Etat de la réservation</label>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="Etat" id="En Attente" value="EnAttente">
                        <label class="form-check-label" for="EnAttente">En Attente</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="Etat" id="enCours" value="enCours">
                        <label class="form-check-label" for="enCours">En Cours</label>
                    </div>
                    <br>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="Etat" id="Refusee" value="Refusee">
                        <label class="form-check-label" for="Refusee">Refusée</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="Etat" id="Acceptee" value="Acceptee">
                        <label class="form-check-label" for="Acceptee">Acceptée</label>
                    </div>
                    <br><br>
                </div>

                <div class="form-group">
                    <label style="display: block;">Annulation</label>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="Annulation" id="client" value="0">
                        <label class="form-check-label" for="client">Client</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="Annulation" id="placeInsuffisantes" value="1">
                        <label class="form-check-label" for="placeInsuffisantes">Place Insuffisantes</label>
                    </div>
                    <br><br>
                    <button class="btn btn-danger" onclick="return  AnnulerDossier();">Annuler la réservation</button>
                </div>

            </div>
        </div>

        <div class="main col-lg-2 col-md-6 col-sm-6">
            <div class="container-fluid">
                <div class="form-group">
                    <label for="ParticipantSelector">Participant à modifier</label>
                    <select class="form-control" id="ParticipantSelector" required></select>
                    <div class="invalid-feedback">
                        Champ requis
                    </div>
                    <br>
                    <button class="btn btn-primary" onclick="return ModifierParticipant();">modifier ce participant</button>
                    <br>
                    <br>
                    <br>
                    <br>
                    <br>
                    <br>
                    <button class="btn btn-warning" onclick="return AjouterParticipant();">Ajouter ce participant</button>
                </div>
            </div>
        </div>

        <div class="main col-lg-3 col-md-6 col-sm-6">
            <div class="container-fluid">
                <h3>Participant</h3>

                <form novalidate>
                    <div class="form-group">
                        <label for="Civilite">Civilité</label>
                        <input type="text" placeholder="Civilité" class="form-control" id="Civilite" required />
                        <div class="invalid-feedback">
                            Champ requis
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="Nom">Nom</label>
                        <input type="text" placeholder="Nom" class="form-control" id="Nom" required />
                        <div class="invalid-feedback">
                            Champ requis
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="Prenom">Prenom</label>
                        <input type="text" placeholder="Prenom" class="form-control" id="Prenom" required />
                        <div class="invalid-feedback">
                            Champ requis
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="Adresse">Adresse</label>
                        <input type="text" placeholder="Adresse" class="form-control" id="Adresse" required />
                        <div class="invalid-feedback">
                            Champ requis
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="Telephone">Telephone</label>
                        <input type="text" placeholder="Telephone" class="form-control" id="Telephone" required />
                        <div class="invalid-feedback">
                            Champ requis
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="DateNaissance">Date de naissance</label>
                        <input type="date" class="form-control" id="DateNaissance" />
                    </div>
                    <div class="form-group">
                        <label for="Reduction">Reduction</label>
                        <input type="text" placeholder="Reduction" class="form-control" id="Reduction" required />
                        <div class="invalid-feedback">
                            Champ requis
                        </div>
                    </div>


                </form>

            </div>
        </div>

    </div>
    <script>
           $(document).ready(function () { 
            var id = GetURLParameter('id');
            var voyageID;
            var clientID;

            promise = Load('DossiersReservations', id); 
            promise.then(function (item) {
                voyageID = item.VoyageID;
                clientID = item.ClientID;
                $('#NumeroCB').val(item.NumeroCarteBancaire);
                $('#PrixPersonne').val(item.PrixParPersonne);
                console.log(item.Etat);
                $('#' + item.Etat).attr('checked', true);
                //$('[name=Etat]:checked').val(item.Etat)
                /* $('#Voyage').val(item.VoyageID);
                $('#Client').val(item.ClientID); */
            });

            AppendLoadToSelect('Voyage', voyageID, 'Client', clientID);
        })

        //menu déroulant
        function AppendLoadToSelect(selectIdVoyage, voyageIDSelected, selectIdclient, clientIDSelected) {
            var selectVoyage = $("#" + selectIdVoyage);
            selectVoyage.empty();
            let pro = Load('voyages?details=true');//edit controller name
            pro.then(function (values) {
                for (item of values) {
                    var option = $('<option></option>');
                    option.val(item.ID);
                    option.text(item.Destination.Pays + " / " + item.Destination.Region + ' -- ' + "Aller:"  + item.DateAller.substring(0, 10) + ' -- ' + ' Retour: ' + item.DateRetour.substring(0, 10));         
                    if (item.ID === voyageIDSelected) {
                        option.attr('selected', 'selected');
                    }
                    selectVoyage.append(option);
                }
            });

            var selectClient = $("#" + selectIdclient);
            selectClient.empty();
            pro = Load('clients');//edit controller name
            pro.then(function (values) {
                for (item of values) {
                    var option = $('<option></option>');
                    option.val(item.ID);
                    option.text(item.Nom + ' ' + item.Prenom + ' - ' + item.Email);//edit here          
                    if (item.ID === clientIDSelected) {
                        option.attr('selected', 'selected');
                    }
                    selectClient.append(option);
                }
            });
        }
        function AjouterParticipant() {
            //ToDo
        }
        function ModifierParticipant() {
            //ToDo
        }
        function VerifierSolvabilite() {
            //ToDo
        }
        function AccepterDossier() {
            //ToDo
        }
        function RefuserDossier() {
            //ToDo
        }

        /* function ValiderEtat() {
            //ToDo
        } */
        function AnnulerDossier() {
            //ToDo
        }


            


        function Valider() {
            var form = $('form');
            let estValide = form[0].checkValidity();
            form.addClass("was-validated");

            return estValide;
        }

        function Enregistrer(id) {
            if (!Valider()) {
                return false;
            }
            var id = GetURLParameter('id');

            let dossierReservation = { 
                NumeroCarteBancaire: $('#NumeroCB').val(),
                PrixParPersonne: $('#PrixPersonne').val(),
                VoyageID: $('#Voyage').val(),
                ClientID: $('#Client').val(),
                Etat: $('[name=Etat]:checked').val(),
                XXXXXX: $('#NbParticipant').val()//TODO
            };

            $.ajax({
                type: 'PUT',
                url: '/api/DossiersReservations/' + id,
                data: dossierReservation,
                success: function () {
                    window.location.href = '/Application/HTML/DossierList.html';
                },
                error: function (response) {
                    Erreur(response);
                }
            });

            return false;
        }





    </script>
</body>

</html>